---
layout: post
title: ç‰›åˆ€å°è¯•ï¼šelectron ä¸­è°ƒç”¨ rust æ¨¡å—è§£æå´©æºƒæ–‡ä»¶
link: dive-shallow-use-rust-library-to-parse-minidump-in-electron-app
date:   2023-11-12 20:00:00 +0800
categories: node.js rust
---

> æ˜¯ğŸ¦€ï¼Œæˆ‘åŠ äº†ğŸ¦€

## å´©æºƒæ–‡ä»¶çš„é—®é¢˜ï¼Œå®ƒä¹Ÿæ˜¯é—®é¢˜...

å¯¹äºä¸€ä¸ª electron åº”ç”¨æ¥è¯´ï¼Œä½¿ç”¨æ¡†æ¶è‡ªå¸¦çš„ `crashReporter` API æ•è·åº”ç”¨è¿›ç¨‹çš„å´©æºƒå®åœ¨æ˜¯å¤ªå®¹æ˜“ä¸è¿‡äº†ï¼š

```ts
import { crashReporter } from 'electron';

crashReporter.start();
```

è®¾ç½®åï¼Œåº”ç”¨ä¼šå¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„ç›‘å¬è¿›ç¨‹ï¼Œåœ¨åº”ç”¨çš„å…¶ä»–è¿›ç¨‹å‘ç”Ÿå´©æºƒæ—¶ï¼Œè¯¥ç›‘å¬è¿›ç¨‹ä¼šæ•è·åˆ°è¿™äº›è¿›ç¨‹çš„å´©æºƒä¿¡æ¯ï¼Œå¹¶å°†åç¼€åä¸º `.dmp` çš„è½¬å‚¨æ–‡ä»¶ï¼ˆå®é™…ä¸Šæ˜¯ minidump æ–‡ä»¶ï¼‰å†™å…¥åˆ°ç‰¹å®šçš„å´©æºƒç›®å½•ä¸­ã€‚å¦‚æœåº”ç”¨åŒæ—¶ä¹Ÿæ¥å…¥äº†ä¸€äº›å´©æºƒé‡‡é›†æœåŠ¡ï¼ˆä¾‹å¦‚ sentryï¼‰ï¼Œè¿™äº› dump æ–‡ä»¶ä¹Ÿä¼šè¢«ä¸Šä¼ åˆ°æœåŠ¡å™¨è¿›è¡Œè§£æã€ç¬¦å·è¡¨æ˜ å°„ã€åˆ†ç±»å½’æ¡£ï¼Œä¾›å¼€å‘è€…åˆ†æã€æ’æŸ¥ã€‚ï¼ˆ...and more in real user caseï¼‰

(å›¾ç‰‡ï¼šæè¿°å´©æºƒé‡‡é›†->æœ¬åœ°æ–‡ä»¶->æœåŠ¡ç«¯è®°å½•)
ï¼ˆhttps://chromium.googlesource.com/crashpad/crashpad/+/refs/heads/main/doc/overview_design.mdï¼‰

ç”±äº electron åº”ç”¨çš„å¤šè¿›ç¨‹ç‰¹æ€§ï¼Œå´©æºƒç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œæ—¢å¯èƒ½æ˜¯æ¥è‡ªäºæ¡†æ¶çš„**è¾…åŠ©è¿›ç¨‹**ä¾‹å¦‚ Network Serviceã€GPU Serviceï¼ˆæ¡†æ¶ä¼šè‡ªåŠ¨é‡æ–°æ‹‰èµ·è¾…åŠ©è¿›ç¨‹ï¼‰ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªäºæŸä¸ªåŠŸèƒ½çš„ **node.js å­è¿›ç¨‹**ï¼ˆä¸šåŠ¡å®ç°ä¸Šä¼šåšå¼‚å¸¸å¤„ç†ï¼‰ï¼Œè€Œä¸æ˜¯ç”¨æˆ·å¯æ„ŸçŸ¥åº”ç”¨å­˜æ´»æ‰€ä¾èµ–çš„**ä¸»è¿›ç¨‹**æˆ–**çª—å£è¿›ç¨‹**â€”â€”è¿™ç»™æˆ‘ä»¬é‡‡é›†ä¸ŠæŠ¥ã€è®¡ç®—åº”ç”¨çš„çœŸå®å´©æºƒç‡é€ æˆäº†å¾ˆå¤§çš„å›°æ‰°ï¼šå¦‚ä½•å‡†ç¡®çš„è·å–è¿™äº›å´©æºƒæ–‡ä»¶å¯¹åº”çš„è¿›ç¨‹ç±»åˆ«ï¼Ÿ

åœ¨æ¥å…¥äº†è¾ƒæ–°ç‰ˆæœ¬çš„ Sentry æœåŠ¡åï¼Œæˆ‘ä»¬å‘ç° Sentry ä¸Šçš„å´©æºƒè®°å½•è¯¦æƒ…ä¸­ï¼Œæ–°å¢äº†å‘ç”Ÿå´©æºƒçš„è¿›ç¨‹å’Œç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ï¼š

ï¼ˆå›¾ç‰‡ï¼šSentry çš„æŸä¸ªå´©æºƒä¿¡æ¯è¯¦æƒ…ï¼‰

è¿™å¸¦ç»™æˆ‘ä»¬ä»¥å¯å‘ï¼šæ—¢ç„¶ Sentry èƒ½è§£å‡ºè¿™äº›å´©æºƒæ–‡ä»¶ä¸­çš„è¿›ç¨‹ä¿¡æ¯ï¼Œé‚£æˆ‘ä»¬æ˜¯å¦å¯ä»¥åœ¨å®¢æˆ·ç«¯ä¾§ä¹Ÿè¿›è¡Œå´©æºƒæ–‡ä»¶è§£æï¼Œä»è€Œåœ¨ç«¯ä¾§å‡†ç¡®çš„è·å¾—å®¢æˆ·ç«¯çš„çœŸå®å´©æºƒæƒ…å†µï¼Œåšä¸€äº›é’ˆå¯¹æ€§çš„åˆ¤æ–­ã€å¸®åŠ©æç¤ºæˆ–ä¼˜åŒ–ï¼Ÿ

## å®¢æˆ·ç«¯ä¾§è§£æå´©æºƒï¼Œèƒ½ä¸èƒ½è¡Œï¼Ÿ

electron ä¸­çš„ `crash-reporter` å®é™…ä¸Šä½¿ç”¨çš„æ˜¯ chromium å¼€æºå·¥ç¨‹ä¸­çš„ `crashpad`ã€‚æ ¹æ®æºç åŠæ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¯‘å‡ºå¯¹åº”å¹³å°çš„å¯æ‰§è¡Œçš„è§£æç¨‹åºã€‚ä½†æˆ‘ä»¬æ›´å¸Œæœ›çš„æ˜¯ä¸€ç§å¯ä¾›ç¼–ç¨‹å¼è°ƒç”¨çš„æ¥å£ï¼Œè¿™ç‚¹å®˜æ–¹å¹¶æœªæä¾›ã€‚å¼€æºç¤¾åŒºä¸­è™½ç„¶æœ‰ä¸€ä¸ª `node-minidump`ï¼Œä½†å®ƒæœ¬è´¨ä¸Šä¹Ÿåªæ˜¯ä¸Šè¿°ç¼–è¯‘äº§ç‰©çš„å¥—å£³ï¼Œä¸æ»¡è¶³æˆ‘ä»¬çš„ä½¿ç”¨é¢„æœŸã€‚å¥½åœ¨ Sentry ä¹Ÿæ˜¯å®Œå…¨å¼€æºçš„ï¼Œä¸å¦¨ä»å®ƒå…¥æ‰‹ï¼Œçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆåšçš„ï¼š

ï¼ˆå›¾ç‰‡ï¼šsentry éƒ¨ç½²æ¶æ„å›¾ï¼‰

æ˜¾ç„¶ï¼Œå›¾ä¸­çš„ `Symbolicator` å³æ˜¯è´Ÿè´£å¤„ç†å´©æºƒæ–‡ä»¶çš„æœåŠ¡èŠ‚ç‚¹ã€‚è¯¥æœåŠ¡ä½¿ç”¨äº† [symbolic](https://github.com/getsentry/symbolic) ä½œä¸ºè§£æå·¥å…·ï¼Œè€Œ `symbolic` æ˜¯ Sentry å›¢é˜Ÿå¼€å‘çš„ä¸€ä¸ªé›†ä¸­è§£æå„ç§å¸¸è§åº”ç”¨å´©æºƒæ–‡ä»¶çš„ rust åº“ï¼Œå®ƒè°ƒç”¨ [rust-minidump](https://github.com/rust-minidump/rust-minidump) è§£æ electron ç­‰åº”ç”¨äº§å‡ºçš„ minidump æ–‡ä»¶ã€‚

æ ¹æ®æ–‡æ¡£ï¼Œç”±äºæˆ‘ä»¬ç›®å‰çš„è¯‰æ±‚ä»…é™äºè§£æå‡º minidump æ–‡ä»¶æºå¸¦çš„è¿›ç¨‹ä¿¡æ¯ï¼Œå¹¶ä¸åŒ…æ‹¬è¿˜åŸè°ƒç”¨å †æ ˆåŠç¬¦å·è¡¨æ˜ å°„ï¼Œä½¿ç”¨æœ€åŸºæœ¬çš„ rust-minidump å°±å¯ä»¥æ»¡è¶³ã€‚æ¥ä¸‹æ¥è¯•ç€ç¼–å†™ä¸€æ®µ rust ä»£ç ï¼ŒéªŒè¯æ˜¯å¦å¯è¡Œï¼ˆæ­¤å¤„çœç•¥ 5000 å­—ä»“ä¿ƒå­¦ä¹  rust è¯­æ³•è¿‡ç¨‹ï¼‰ï¼š

```rust
use minidump::*;

fn main() -> Result<(), Error> {
    // Read the minidump from a file
    let mut dump = minidump::Minidump::read_path("../testdata/test.dmp")?;

    // Statically request (and require) several streams we care about:
    let system_info = dump.get_stream::<MinidumpSystemInfo>()?;
    let exception = dump.get_stream::<MinidumpException>()?;

    // Combine the contents of the streams to perform more refined analysis
    let crash_reason = exception.get_crash_reason(system_info.os, system_info.cpu);

    // Conditionally analyze a stream
    if let Ok(threads) = dump.get_stream::<MinidumpThreadList>() {
        // Use `Default` to try to make progress when a stream is missing.
        // This is especially natural for MinidumpMemoryList because
        // everything needs to handle memory lookups failing anyway.
        let mem = dump.get_memory().unwrap_or_default();

        for thread in &threads.threads {
            let stack = thread.stack_memory(&mem);
            // ...
        }
    }
    Ok(())
}
```

Bingo! ç¨‹åºæˆåŠŸæ‰“å°å‡ºäº†ä¼ å…¥çš„å´©æºƒæ–‡ä»¶çš„çœŸå®è¿›ç¨‹ç±»å‹ï¼Œå¯è¡Œæ€§å¾—åˆ°äº†éªŒè¯ã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ç¼–å†™åœ¨ electron åº”ç”¨ï¼ˆå…¶å®æ˜¯ node.js ç¯å¢ƒï¼‰ä¸­è°ƒç”¨ rust çš„æ‹“å±•ç¨‹åºã€‚

## ç¼–å†™ node.js rust æ‹“å±•ç¨‹åº

å†™è¿‡ node.js C++ æ‹“å±•çš„å°ä¼™ä¼´å¯èƒ½ä¼šçŸ¥é“ï¼Œnode.js å®˜æ–¹åœ¨ v8.0 ç‰ˆæœ¬åæ¨å‡ºäº† ABI-Stable çš„ [napi](https://nodejs.org/api/n-api.html) æ¡†æ¶ï¼Œä¿éšœå…¶åœ¨æ‰€æœ‰çš„åç»­ node.js ç‰ˆæœ¬ä¸­å…¼å®¹ã€‚è‡ªæ­¤ä¹‹åï¼Œç¤¾åŒºæ´»è·ƒçš„æºç”Ÿæ¨¡å—çº·çº·è¿å¾€ `napi` å®ç°ï¼Œå½»åº•ç»ˆç»“äº†ä»¥å‰ node.js ç‰ˆæœ¬å˜åŒ–å°±ä¸å¾—ä¸é‡ç¼–æºç”Ÿä¾èµ–çš„æ—¶ä»£ã€‚ä½†åœ¨è°ƒç”¨ rust ä»£ç æ–¹é¢ï¼Œå¹¶æ²¡æœ‰è¿™æ ·çš„ä¸€å¥—ç”± node.js å®˜æ–¹ç»´æŠ¤æˆ–æ¨èçš„æ¡†æ¶ã€‚ç›®å‰ï¼Œrust ç¤¾åŒºä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ node.js rust æ‹“å±•æ¡†æ¶ï¼Œåˆ†åˆ«æ˜¯:

- [neon-binding](https://github.com/neon-bindings/neon): å¯èƒ½æ˜¯ rust ç¤¾åŒºæœ€æ—©çš„ node.js rust æ‹“å±•æ¡†æ¶ã€‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ rust ç‰ˆçš„ babelâ€”â€”[swc](https://github.com/swc-project/swc) æ—©æœŸçš„ç‰ˆæœ¬æ›¾ä½¿ç”¨è¿‡å®ƒäº§å‡º node.js bindingã€‚ä¸è¿‡ä¼¼ä¹æ–‡æ¡£å’Œæ•™ç¨‹éƒ½æ¯”è¾ƒç®€å•ï¼Œä¸Šæ‰‹å®é™…è¿ç”¨é—¨æ§›ç¨æœ‰ç‚¹é«˜ã€‚
- [napi-rs](https://github.com/napi-rs/napi-rs): ç›®å‰çœ‹èµ·æ¥æ´»è·ƒåº¦æœ€é«˜ã€æˆç†Ÿæ¡ˆä¾‹æœ€å¤šçš„æ¡†æ¶ï¼Œæä¾›äº†è¯¦å®çš„æ–‡æ¡£å’ŒåŠŸèƒ½è¶…ä¹å¼ºå¤§çš„è„šæ‰‹æ¶ã€‚ä¸Šé¢è¯´åˆ°çš„ swc ä¹Ÿäº 20 å¹´ä» `neon` è¿ç§»åˆ°äº† `napi-rs`([ref](https://github.com/swc-project/swc/issues/852))ã€‚
- [node-bindgen](https://github.com/infinyon/node-bindgen): ç›®å‰çœ‹èµ·æ¥è¿˜æ¯”è¾ƒå°ä¼—ï¼Œæ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæ¡ˆä¾‹ã€‚

ç»è¿‡å¯¹æ¯”ï¼Œæˆ‘ä»¬å†³å®šé€‰ç”¨ `napi-rs` å®ç°åŠŸèƒ½ã€‚`napi-rs` å·²æä¾›äº†ä¸€å¥—å®Œå–„åº¦æé«˜çš„è„šæ‰‹æ¶å·¥ç¨‹ [napi-rs/package-template](https://github.com/napi-rs/package-template)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å®ƒå®ç°ç›®æ ‡åŠŸèƒ½ã€‚

### æ­å»ºå·¥ç¨‹æ¨¡æ¿

é¦–å…ˆæ˜¯å‡†å¤‡å¥½å·¥ç¨‹ä»“åº“ã€‚å¯ä»¥ç›´æ¥ä»è¯¥æ¨¡æ¿ä»“åº“ä¸Šç›´æ¥ clone åˆ°æœ¬åœ°ï¼š

```bash
$ git clone git@github.com:napi-rs/package-template.git
```

æˆ–è€…ä½¿ç”¨ github é¡µé¢ä¸Šæä¾›çš„ "Use this template" åˆ›å»ºä»“åº“å‡å¯ï¼š

![use-repo-template](rs-minidump-repo-use-template.png)

> âš  ç”±äºè¯¥æ¨¡æ¿å·¥ç¨‹ä½¿ç”¨çš„ swc ç‰ˆæœ¬ä»¥åŠæµæ°´çº¿é…ç½®é‡Œçš„è¿è¡Œç¯å¢ƒçš„é™åˆ¶ï¼Œä»¥ä¸‹å¼€å‘è¿‡ç¨‹å‡è¦æ±‚ä½¿ç”¨ node.js v18+ ä»¥åŠ yarn v4+ï¼Œå¦‚æœä½ æ˜¯ yarn classical çš„é—è€é—å°‘ï¼Œè¯·å…ˆæŒ‰éœ€ä½¿ç”¨ nvm é…ç½®å¥½è¿è¡Œç¯å¢ƒ :)ã€‚

æ¥ä¸‹æ¥å®‰è£…ä¾èµ–ï¼Œå¹¶ä¸”å°†æ¨¡æ¿å·¥ç¨‹ä¸­çš„æ¨¡æ¿é¡¹ç›®åç§°æ¢æˆè‡ªå·±çš„é¡¹ç›®åï¼š

```bash
$ yarn install
$ npx napi rename -n my-node-rs-lib
```

`napi` æ˜¯æ¨¡æ¿å†…æä¾›çš„è„šæ‰‹æ¶å·¥ç¨‹è¾…åŠ©å·¥å…·ï¼Œè´Ÿè´£åšå°† rust ç¼–è¯‘äº§ç‰©æœ€ç»ˆå‘å¸ƒä¸º npm åŒ…çš„ä¸€äº›å·¥ç¨‹åŒ–ä¸Šçš„çç¢äº‹é¡¹ï¼Œä¾‹å¦‚è¯»å–çº¦å®šçš„é…ç½®ã€æ„å»ºäº§ç‰©ç§»åŠ¨åˆ°ç‰¹å®šä½ç½®ã€ä¿®æ”¹ç‰ˆæœ¬å·ã€æ‰¹é‡å‘å¸ƒå„å¹³å°é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ç­‰ç­‰ã€‚æ­¤å¤„æˆ‘ä»¬å…ˆæ‰‹åŠ¨ä½¿ç”¨å®ƒæ¥é‡å‘½åå·¥ç¨‹ï¼Œé¿å…å‘åŒ…æ—¶äº§ç”ŸåŒ…åå†²çªã€‚

IDE æç¤º `<project>/npm/` ç›®å½•ä¸‹å¾ˆå¤šå­ç›®å½•çš„æ–‡ä»¶éƒ½å‡ºç°äº† diffï¼š

![alm](rs-minidump-repo-rename.png)

è¿™äº›ç›®å½•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿé€šè¿‡å…¶åç§°ï¼Œå¾ˆå®¹æ˜“çŒœåˆ°å®ƒä»¬åº”è¯¥æ˜¯å½“å‰å·¥ç¨‹ç¼–è¯‘åˆ°å„ä¸ªå¹³å°çš„**é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶**ï¼ˆprebuilt binaryï¼‰çš„å‘å¸ƒç›®å½•ã€‚æ²¡é”™ï¼è¯¥å·¥ç¨‹é¢„é…ç½®äº†å‡ ä¹æ‰€æœ‰ä¸»æµå¹³å°æ¶æ„çš„ç¼–è¯‘ã€å‘å¸ƒèƒ½åŠ›ã€‚ä½†ç›®å‰ï¼Œé‰´äºæˆ‘ä»¬åªæƒ³åœ¨ Windows/MacOS çš„ electron åº”ç”¨ä¸­ä½¿ç”¨ï¼Œå®åœ¨æ˜¯ä¸éœ€è¦è¿™ä¹ˆå¤§è€Œå…¨çš„é…ç½®ï¼Œå¯ä»¥ç›´æ¥åšä¸€äº›åˆ å‡ã€‚åœ¨ `<project>/package.json` ä¸­ï¼Œä¿®æ”¹ `napi` é…ç½®é¡¹çš„å€¼ï¼š

![Alt text](rs-minidump-repo-build-target.png)

åœ¨æ­¤ï¼Œæˆ‘ä»¬ä»…ä¿ç•™äº† Windows x64/Windows ia32/MacOS Arm64/MacOS x64 è¿™å››ç§å¹³å°æ¶æ„ä½œä¸ºæ„å»ºç›®æ ‡ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ `defaults` è¦è°ƒæ•´ä¸º `false` ä»¥é˜»æ­¢å…¶é»˜è®¤çš„å¹³å°äº§ç‰©æ„å»ºï¼Œå¦åˆ™ç¨åå‘å¸ƒè¿‡ç¨‹ä¸­ä¼šæœ‰è€—è´¹ä½ ä¸€å°æ—¶ DEBUG çš„ç¥ç§˜äº‹ä»¶å‘ç”Ÿã€‚ç›¸åº”çš„ï¼Œ`<project>/npm/` ç›®å½•ä¸‹é‚£äº›ä¸éœ€è¦çš„ç›®æ ‡ç›®å½•ä¹Ÿéƒ½å¯ä»¥ç›´æ¥åˆ é™¤äº†ã€‚

> âš  å®Œæ•´çš„å¯æ”¯æŒçš„ç¼–è¯‘ç›®æ ‡å¹³å°ä»£å·åˆ—è¡¨ï¼Œå¯å‚çœ‹ [rust platform support](https://doc.rust-lang.org/nightly/rustc/platform-support.html)

### ç¼–ç  & éªŒè¯


### å‘å¸ƒ & ä½¿ç”¨


## References

- <https://www.electronjs.org/docs/latest/api/crash-reporter>
- <https://chromium.googlesource.com/crashpad/crashpad/+/refs/heads/main/README.md>
- <https://github.com/getsentry/symbolicator>
- <https://lyn.one/2020/09/11/rust-napi>
